<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Fullstack Lab do Adelmo üöÄ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
    }
    h1, h2, h3 {
      margin-top: 30px;
    }
    pre {
      background: #f3f3f3;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
      white-space: pre-wrap;
    }
    button {
      padding: 6px 12px;
      border: none;
      background: #2563eb;
      color: white;
      cursor: pointer;
      border-radius: 6px;
      margin-top: 6px;
    }
    button:hover {
      background: #1d4ed8;
    }
    input {
      padding: 6px;
      margin-top: 4px;
      width: 250px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    hr {
      margin: 40px 0;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    th {
      background: #f5f5f5;
      text-align: left;
    }
    .actions button {
      margin-right: 6px;
    }
    .small-input {
      width: 120px;
    }
  </style>
</head>
<body>

<h1>Fullstack Lab do Adelmo üöÄ</h1>

<!-- -------------------------------------------------------------
     TESTE DA API
-------------------------------------------------------------- -->
<h2>Teste da API</h2>

<button id="btnHealth">Chamar /api/health</button>
<pre id="healthResult"></pre>

<button id="btnMsg">Chamar /api/message</button>
<pre id="msgResult"></pre>

<hr>

<!-- -------------------------------------------------------------
     CADASTRO REAL DE USU√ÅRIO
-------------------------------------------------------------- -->
<h2>Cadastro de Usu√°rio</h2>

<form id="userForm">
  <label>
    Nome:
    <input type="text" id="nameInput" required />
  </label>

  <label>
    E-mail:
    <input type="email" id="emailInput" required />
  </label>

  <label>
    Senha:
    <input type="password" id="passwordInput" required />
  </label>

  <button type="submit">Cadastrar usu√°rio</button>
</form>

<pre id="userCreateResult"></pre>

<hr>

<!-- -------------------------------------------------------------
     LISTA + A√á√ïES (EDITAR / EXCLUIR)
-------------------------------------------------------------- -->
<h2>Gerenciar usu√°rios</h2>

<button id="btnLoadUsers">Carregar /api/users</button>
<div id="usersTable"></div>

<hr>

<!-- -------------------------------------------------------------
     FORMUL√ÅRIO DE ATUALIZA√á√ÉO
-------------------------------------------------------------- -->
<h3>Atualizar usu√°rio</h3>

<p>Selecione um usu√°rio na tabela (bot√£o "Editar") ou informe o ID manualmente.</p>

<form id="updateForm">
  <label>
    ID:
    <input type="number" id="updateIdInput" class="small-input" required />
  </label>

  <label>
    Novo nome (opcional):
    <input type="text" id="updateNameInput" />
  </label>

  <label>
    Novo e-mail (opcional):
    <input type="email" id="updateEmailInput" />
  </label>

  <label>
    Nova senha (opcional):
    <input type="password" id="updatePasswordInput" />
  </label>

  <button type="submit">Atualizar usu√°rio</button>
</form>

<pre id="updateResult"></pre>

<!-- -------------------------------------------------------------
     JAVASCRIPT
-------------------------------------------------------------- -->
<script>
// Fun√ß√£o gen√©rica para chamar rotas GET
async function callApi(path, outputId) {
  const out = document.getElementById(outputId);
  out.textContent = "Carregando...";

  try {
    const res = await fetch(path);
    const data = await res.json();
    out.textContent = JSON.stringify(data, null, 2);
  } catch (err) {
    out.textContent = "Erro: " + err.message;
  }
}

// Bot√µes de teste
document
  .getElementById("btnHealth")
  .addEventListener("click", () => callApi("/api/health", "healthResult"));

document
  .getElementById("btnMsg")
  .addEventListener("click", () => callApi("/api/message", "msgResult"));

// Cadastro real de usu√°rio
document.getElementById("userForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const name = document.getElementById("nameInput").value.trim();
  const email = document.getElementById("emailInput").value.trim();
  const password = document.getElementById("passwordInput").value.trim();
  const out = document.getElementById("userCreateResult");

  out.textContent = "Enviando...";

  try {
    const res = await fetch("/api/users", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, email, password }),
    });

    const data = await res.json();
    out.textContent = JSON.stringify(data, null, 2);

    // recarrega lista depois de cadastrar
    await loadUsers();
  } catch (err) {
    out.textContent = "Erro: " + err.message;
  }
});

// ------- LISTAR USU√ÅRIOS E RENDERIZAR TABELA -------

async function loadUsers() {
  const container = document.getElementById("usersTable");
  container.innerHTML = "Carregando usu√°rios...";

  try {
    const res = await fetch("/api/users");
    const users = await res.json();

    if (!Array.isArray(users)) {
      container.innerHTML = "<p>Resposta inesperada da API.</p>";
      console.error("Resposta inesperada:", users);
      return;
    }

    if (users.length === 0) {
      container.innerHTML = "<p>Nenhum usu√°rio cadastrado ainda.</p>";
      return;
    }

    let html = `
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>E-mail</th>
            <th>Criado em</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
    `;

    for (const u of users) {
      html += `
        <tr>
          <td>${u.id}</td>
          <td>${u.name}</td>
          <td>${u.email}</td>
          <td>${u.created_at || ""}</td>
          <td class="actions">
            <button class="edit-btn"
              data-id="${u.id}"
              data-name="${u.name}"
              data-email="${u.email}">
              Editar
            </button>
            <button class="delete-btn" data-id="${u.id}">
              Excluir
            </button>
          </td>
        </tr>
      `;
    }

    html += `
        </tbody>
      </table>
    `;

    container.innerHTML = html;

    // ligar eventos dos bot√µes
    attachRowHandlers();
  } catch (err) {
    container.innerHTML = "<p>Erro ao carregar usu√°rios.</p>";
    console.error(err);
  }
}

function attachRowHandlers() {
  const editButtons = document.querySelectorAll(".edit-btn");
  const deleteButtons = document.querySelectorAll(".delete-btn");

  const idInput = document.getElementById("updateIdInput");
  const nameInput = document.getElementById("updateNameInput");
  const emailInput = document.getElementById("updateEmailInput");

  editButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const id = btn.dataset.id;
      const name = btn.dataset.name;
      const email = btn.dataset.email;

      idInput.value = id;
      nameInput.value = name;
      emailInput.value = email;

      // opcional: rolar at√© o formul√°rio de update
      document.getElementById("updateForm").scrollIntoView({ behavior: "smooth" });
    });
  });

  deleteButtons.forEach((btn) => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      const confirmDelete = confirm(`Tem certeza que deseja excluir o usu√°rio ID ${id}?`);
      if (!confirmDelete) return;

      try {
        const res = await fetch(`/api/users/${id}`, {
          method: "DELETE",
        });

        if (!res.ok && res.status !== 204) {
          const text = await res.text();
          alert(`Erro ao excluir usu√°rio: ${res.status} - ${text}`);
          return;
        }

        await loadUsers();
      } catch (err) {
        alert("Erro de rede ao excluir usu√°rio: " + err.message);
      }
    });
  });
}

document.getElementById("btnLoadUsers").addEventListener("click", loadUsers);

// ------- ATUALIZAR USU√ÅRIO (PUT /api/users/:id) -------

document.getElementById("updateForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const id = document.getElementById("updateIdInput").value.trim();
  const name = document.getElementById("updateNameInput").value.trim();
  const email = document.getElementById("updateEmailInput").value.trim();
  const password = document.getElementById("updatePasswordInput").value.trim();
  const out = document.getElementById("updateResult");

  if (!id) {
    out.textContent = "Informe o ID do usu√°rio.";
    return;
  }

  const payload = {};
  if (name) payload.name = name;
  if (email) payload.email = email;
  if (password) payload.password = password;

  if (Object.keys(payload).length === 0) {
    out.textContent = "Nada para atualizar. Informe ao menos um campo.";
    return;
  }

  out.textContent = "Atualizando...";

  try {
    const res = await fetch(`/api/users/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const data = await res.json();
    if (!res.ok) {
      out.textContent = `Erro ${res.status}: ` + JSON.stringify(data);
      return;
    }

    out.textContent = JSON.stringify(data, null, 2);

    // limpa s√≥ o campo de senha, pra seguran√ßa
    document.getElementById("updatePasswordInput").value = "";

    await loadUsers();
  } catch (err) {
    out.textContent = "Erro: " + err.message;
  }
});
</script>

</body>
</html>
