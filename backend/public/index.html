<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerenciamento de Usu√°rios - Fullstack Lab do Adelmo üöÄ</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #0f172a;
      color: #e5e7eb;
    }
    header {
      background: #020617;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #1f2937;
    }
    header h1 {
      font-size: 1.4rem;
      margin: 0;
    }
    header span {
      font-size: 0.9rem;
      color: #9ca3af;
    }
    main {
      padding: 24px;
      max-width: 1000px;
      margin: 0 auto;
    }
    .card {
      background: #111827;
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 16px;
      border: 1px solid #1f2933;
    }
    .card h2 {
      margin-top: 0;
      font-size: 1.2rem;
    }
    pre {
      background: #020617;
      padding: 8px;
      border-radius: 8px;
      font-size: 0.85rem;
      overflow-x: auto;
      border: 1px solid #1f2937;
    }
    button {
      background: #2563eb;
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      color: #f9fafb;
      font-weight: 500;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button:hover {
      filter: brightness(1.1);
    }
    .danger {
      background: #dc2626;
    }
    input, select {
      padding: 6px;
      margin-top: 4px;
      border-radius: 4px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      width: 260px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    hr {
      margin: 24px 0;
      border-color: #1f2937;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #1f2937;
      padding: 8px;
    }
    th {
      background: #020617;
      text-align: left;
    }
    .actions button {
      margin-right: 4px;
    }
    .small-input {
      width: 120px;
    }
    a {
      color: #60a5fa;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .badge {
      display: inline-block;
      margin-left: 8px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      text-transform: uppercase;
      background: #f97316;
      color: #02101f;
      font-weight: 600;
    }
  </style>
</head>
<body>

<header>
  <div>
    <h1>Fullstack Lab do Adelmo üöÄ</h1>
    <span>Gerenciamento de usu√°rios ¬∑ somente admin</span>
  </div>
  <div>
    <button onclick="window.location.href='/dashboard.html'">Voltar ao dashboard</button>
    <button id="logoutBtn" class="danger">Logout</button>
  </div>
</header>

<main>
  <!-- TESTE DA API -->
  <section class="card">
    <h2>Teste da API</h2>
    <button id="btnHealth">Chamar /api/health</button>
    <pre id="healthResult"></pre>

    <button id="btnMsg">Chamar /api/message</button>
    <pre id="msgResult"></pre>
  </section>

  <!-- CADASTRO -->
  <section class="card">
    <h2>Cadastro de Usu√°rio</h2>
    <form id="userForm">
      <label>
        Nome:
        <input type="text" id="nameInput" required />
      </label>

      <label>
        E-mail:
        <input type="email" id="emailInput" required />
      </label>

      <label>
        Senha:
        <input type="password" id="passwordInput" required />
      </label>

      <label>
        Papel (role):
        <select id="roleInput">
          <option value="user">Usu√°rio comum</option>
          <option value="admin">Administrador</option>
        </select>
      </label>

      <button type="submit" class="mt-2">Cadastrar usu√°rio</button>
    </form>

    <pre id="userCreateResult"></pre>
  </section>

  <!-- LISTA + EDITAR/EXCLUIR -->
  <section class="card">
    <h2>Gerenciar usu√°rios</h2>
    <button id="btnLoadUsers">Carregar /api/users</button>
    <div id="usersTable"></div>
  </section>

  <!-- ATUALIZA√á√ÉO -->
  <section class="card">
    <h2>Atualizar usu√°rio</h2>
    <p style="font-size:0.85rem;color:#9ca3af;">
      Clique em "Editar" na tabela para preencher este formul√°rio automaticamente.
    </p>
    <form id="updateForm">
      <label>
        ID:
        <input type="number" id="updateIdInput" class="small-input" required />
      </label>

      <label>
        Novo nome (opcional):
        <input type="text" id="updateNameInput" />
      </label>

      <label>
        Novo e-mail (opcional):
        <input type="email" id="updateEmailInput" />
      </label>

      <label>
        Nova senha (opcional):
        <input type="password" id="updatePasswordInput" />
      </label>

      <label>
        Novo papel (role) (opcional):
        <select id="updateRoleInput">
          <option value="">(manter)</option>
          <option value="user">Usu√°rio comum</option>
          <option value="admin">Administrador</option>
        </select>
      </label>

      <button type="submit" class="mt-2">Atualizar usu√°rio</button>
    </form>

    <pre id="updateResult"></pre>
  </section>
</main>

<script>
(async function() {
  // ---------- PROTE√á√ÉO: S√ì ADMIN ENTRA AQUI ----------
  const token = localStorage.getItem("token");
  if (!token) {
    window.location.href = "/login.html";
    return;
  }

  async function apiFetch(path, options = {}) {
    const opts = {
      ...options,
      headers: {
        ...(options.headers || {}),
        "Content-Type": "application/json",
        Authorization: "Bearer " + token,
      },
    };
    const res = await fetch(path, opts);
    return res;
  }

  // Verificar se √© admin antes de carregar qualquer coisa
  try {
    const resMe = await apiFetch("/api/me", { method: "GET", headers: {} });
    if (!resMe.ok) {
      localStorage.removeItem("token");
      window.location.href = "/login.html";
      return;
    }
    const me = await resMe.json();
    if (!me.user || me.user.role !== "admin") {
      // n√£o √© admin ‚Üí volta pro dashboard
      window.location.href = "/dashboard.html";
      return;
    }
  } catch (err) {
    console.error("Erro ao verificar admin:", err);
    localStorage.removeItem("token");
    window.location.href = "/login.html";
    return;
  }

  // ---------- A PARTIR DAQUI: S√ì ADMIN EXECUTA ----------

  const healthResult = document.getElementById("healthResult");
  const msgResult = document.getElementById("msgResult");
  const userCreateResult = document.getElementById("userCreateResult");
  const usersTable = document.getElementById("usersTable");
  const updateResult = document.getElementById("updateResult");

  // logout
  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("token");
    window.location.href = "/login.html";
  });

  // teste de API
  document.getElementById("btnHealth").addEventListener("click", async () => {
    try {
      const res = await fetch("/api/health");
      const data = await res.json();
      healthResult.textContent = JSON.stringify(data, null, 2);
    } catch (err) {
      healthResult.textContent = "Erro: " + err.message;
    }
  });

  document.getElementById("btnMsg").addEventListener("click", async () => {
    try {
      const res = await fetch("/api/message");
      const data = await res.json();
      msgResult.textContent = JSON.stringify(data, null, 2);
    } catch (err) {
      msgResult.textContent = "Erro: " + err.message;
    }
  });

  // criar usu√°rio
  document.getElementById("userForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = document.getElementById("nameInput").value.trim();
    const email = document.getElementById("emailInput").value.trim();
    const password = document.getElementById("passwordInput").value.trim();
    const role = document.getElementById("roleInput").value;
    userCreateResult.textContent = "Enviando...";

    try {
      const res = await apiFetch("/api/users", {
        method: "POST",
        body: JSON.stringify({ name, email, password, role }),
      });
      const data = await res.json();
      if (!res.ok) {
        userCreateResult.textContent =
          "Erro " + res.status + ": " + JSON.stringify(data);
        return;
      }
      userCreateResult.textContent = JSON.stringify(data, null, 2);
      await loadUsers();
    } catch (err) {
      userCreateResult.textContent = "Erro: " + err.message;
    }
  });

  // carregar usu√°rios
  async function loadUsers() {
    usersTable.innerHTML = "Carregando usu√°rios...";
    try {
      const res = await apiFetch("/api/users", { method: "GET" });
      if (!res.ok) {
        const text = await res.text();
        usersTable.innerHTML =
          "Erro ao carregar usu√°rios (" + res.status + "): " + text;
        return;
      }
      const users = await res.json();
      if (!Array.isArray(users)) {
        usersTable.innerHTML = "Resposta inesperada da API.";
        console.error("Resposta inesperada:", users);
        return;
      }
      if (users.length === 0) {
        usersTable.innerHTML = "<p>Nenhum usu√°rio cadastrado.</p>";
        return;
      }

      let html = `
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Nome</th>
              <th>E-mail</th>
              <th>Role</th>
              <th>Criado em</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
      `;
      for (const u of users) {
        html += `
          <tr>
            <td>${u.id}</td>
            <td>${u.name}</td>
            <td>${u.email}</td>
            <td>${u.role}</td>
            <td>${u.created_at || ""}</td>
            <td class="actions">
              <button class="edit-btn"
                data-id="${u.id}"
                data-name="${u.name}"
                data-email="${u.email}"
                data-role="${u.role}">
                Editar
              </button>
              <button class="delete-btn" data-id="${u.id}">Excluir</button>
            </td>
          </tr>
        `;
      }
      html += "</tbody></table>";
      usersTable.innerHTML = html;
      attachRowHandlers();
    } catch (err) {
      usersTable.innerHTML = "Erro: " + err.message;
    }
  }

  document.getElementById("btnLoadUsers").addEventListener("click", loadUsers);

  function attachRowHandlers() {
    const editButtons = document.querySelectorAll(".edit-btn");
    const deleteButtons = document.querySelectorAll(".delete-btn");

    const idInput = document.getElementById("updateIdInput");
    const nameInput = document.getElementById("updateNameInput");
    const emailInput = document.getElementById("updateEmailInput");
    const roleSelect = document.getElementById("updateRoleInput");

    editButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.id;
        const name = btn.dataset.name;
        const email = btn.dataset.email;
        const role = btn.dataset.role;

        idInput.value = id;
        nameInput.value = name;
        emailInput.value = email;
        roleSelect.value = role === "admin" ? "admin" : "user";

        document
          .getElementById("updateForm")
          .scrollIntoView({ behavior: "smooth" });
      });
    });

    deleteButtons.forEach((btn) => {
      btn.addEventListener("click", async () => {
        const id = btn.dataset.id;
        const confirmDelete = confirm(
          `Tem certeza que deseja excluir o usu√°rio ID ${id}?`
        );
        if (!confirmDelete) return;

        try {
          const res = await apiFetch(`/api/users/${id}`, {
            method: "DELETE",
          });
          if (!res.ok && res.status !== 204) {
            const text = await res.text();
            alert(
              `Erro ao excluir usu√°rio (${res.status}): ` +
                text
            );
            return;
          }
          await loadUsers();
        } catch (err) {
          alert("Erro ao excluir usu√°rio: " + err.message);
        }
      });
    });
  }

  // atualizar usu√°rio
  document.getElementById("updateForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const id = document.getElementById("updateIdInput").value.trim();
    const name = document.getElementById("updateNameInput").value.trim();
    const email = document.getElementById("updateEmailInput").value.trim();
    const password = document.getElementById("updatePasswordInput").value.trim();
    const role = document.getElementById("updateRoleInput").value.trim();

    if (!id) {
      updateResult.textContent = "Informe o ID.";
      return;
    }

    const payload = {};
    if (name) payload.name = name;
    if (email) payload.email = email;
    if (password) payload.password = password;
    if (role) payload.role = role;

    if (Object.keys(payload).length === 0) {
      updateResult.textContent =
        "Nada para atualizar. Preencha ao menos um campo.";
      return;
    }

    updateResult.textContent = "Atualizando...";

    try {
      const res = await apiFetch(`/api/users/${id}`, {
        method: "PUT",
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (!res.ok) {
        updateResult.textContent =
          "Erro " + res.status + ": " + JSON.stringify(data);
        return;
      }
      updateResult.textContent = JSON.stringify(data, null, 2);
      document.getElementById("updatePasswordInput").value = "";
      await loadUsers();
    } catch (err) {
      updateResult.textContent = "Erro: " + err.message;
    }
  });

  // Carrega usu√°rios logo na entrada
  await loadUsers();
})(); // fim da prote√ß√£o admin + CRUD
</script>

</body>
</html>
