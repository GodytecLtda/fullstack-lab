<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard - Godytec Fullstack Lab 游</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="/css/dashboard.css" />
</head>
<body>
  <div class="shell">
    <header>
      <div class="brand">
        <div class="brand-title">Godytec Fullstack Lab 游</div>
        <div class="brand-subtitle">Dashboard 췅 치rea protegida</div>
      </div>

      <div class="header-actions">
        <a href="/admin/crud.html" id="headerAdminLink" class="btn-link btn-link-admin">
          游논 Gerenciar usu치rios
        </a>
        <button id="logoutBtn" class="btn-link btn-logout">Logout</button>
      </div>
    </header>

    <main>
      <section class="column">
        <div class="status-card">
          <div class="card-header-line">
            <h2>Status do sistema</h2>
            <span class="status-pill">
              <span class="status-dot"></span> Monitor em tempo real
            </span>
          </div>

          <p class="card-subtitle">
            Snapshot r치pido da sa칰de da API e do banco.
          </p>

          <div class="status-row">
            <span>Servidor</span>
            <div id="status-server" class="status-indicator gray"></div>
          </div>

          <div class="status-row">
            <span>Banco de dados</span>
            <div id="status-db" class="status-indicator gray"></div>
          </div>

          <div class="status-row">
            <span>Lat칡ncia</span>
            <span id="latency-label" class="latency-text">-- ms</span>
          </div>

          <button id="btn-refresh-status" class="btn-refresh">
            Atualizar status
          </button>
        </div>

        <div class="card">
          <h2>Bem-vindo, <span id="welcomeNameSpan" class="welcome-name">Admin</span></h2>
          <p class="card-subtitle">Resumo da sua sess칚o atual no laborat칩rio.</p>

          <div class="info-line">
            <span class="info-label">E-mail: </span>
            <span class="info-value" id="infoEmail">-</span>
          </div>
          <div class="info-line">
            <span class="info-label">ID: </span>
            <span class="info-value" id="infoId">-</span>
          </div>

          <div class="role-line">
            <span class="info-label">Papel:</span>
            <span class="role-badge" id="roleBadge">ADMIN</span>
          </div>

          <div class="quick-actions">
            <button class="btn btn-primary" id="btnGoProfile">
              游녻 Meu Perfil
            </button>
            <button class="btn btn-secondary" id="btnGoAdmin">
              游빌 Gerenciamento de usu치rios (somente admin)
            </button>
          </div>
        </div>

        <div class="card">
          <h2>Estat칤sticas r치pidas</h2>
          <p class="card-subtitle">Vis칚o simples baseada na API de usu치rios.</p>

          <div class="info-line">
            <span class="info-label">Total de usu치rios:</span>
            <span class="info-value" id="totalUsers">-</span>
          </div>

          <button id="btnRefreshUsers" class="btn btn-primary btn-full">
            Atualizar estat칤sticas
          </button>

          <div id="statsStatus" class="status-text"></div>
        </div>
      </section>

      <section class="column">
        <div class="card card-token">
          <div class="card-header-line">
            <h2>Dados brutos da API</h2>
            <span class="mini-label">/api/me + payload do token</span>
          </div>

          <p class="card-subtitle">
            Visualize exatamente o que o backend enxerga sobre a sua sess칚o.
          </p>

          <div class="token-box" id="tokenBox">
            Carregando dados...
          </div>

          <div class="status-text" id="tokenStatus">
            Lendo informa칞칫es da sess칚o...
          </div>
        </div>
      </section>
    </main>

    <footer>
      <span>Ambiente: <strong>Lab Local</strong> (Node + Postgres)</span>
      <span id="footerUser">Usu치rio autenticado: -</span>
    </footer>
  </div>

  <script>
    // Fun칞칫es de utilidade e API
    function getToken() {
      return localStorage.getItem('token');
    }

    function ensureAuthenticated() {
      const token = getToken();
      if (!token) {
        window.location.href = '/html/login.html';
      }
    }

    async function apiRequest(path, options = {}) {
      const token = getToken();
      const headers = options.headers || {};
      headers['Content-Type'] = 'application/json';
      if (token) {
        headers['Authorization'] = 'Bearer ' + token;
      }

      const res = await fetch(path, { ...options, headers });
      const contentType = res.headers.get('content-type') || '';
      const data = contentType.includes('application/json')
        ? await res.json().catch(() => ({}))
        : await res.text().catch(() => '');

      if (!res.ok) {
        const message =
          data?.error || data?.message || 'Erro ao comunicar com o servidor';
        throw new Error(message);
      }
      return data;
    }

    function renderTokenBox(dataFromMe) {
      const tokenBox = document.getElementById('tokenBox');
      const tokenStatus = document.getElementById('tokenStatus');

      const token = getToken();
      const result = { token: null, me: dataFromMe || null };

      if (token) {
        try {
          const payloadBase64 = token.split('.')[1];
          const payloadJson = atob(payloadBase64);
          result.token = JSON.parse(payloadJson);
        } catch (err) {
          result.token = 'Falha ao decodificar token';
        }
      }

      tokenBox.textContent = JSON.stringify(result, null, 2);
      tokenStatus.textContent = 'Dados carregados a partir do token e /api/me.';
    }

    async function loadUserInfo() {
      const welcomeNameSpan = document.getElementById('welcomeNameSpan');
      const infoEmail = document.getElementById('infoEmail');
      const infoId = document.getElementById('infoId');
      const roleBadge = document.getElementById('roleBadge');
      const footerUser = document.getElementById('footerUser');
      const btnGoAdmin = document.getElementById('btnGoAdmin');
      const headerAdminLink = document.getElementById('headerAdminLink');

      try {
        const data = await apiRequest('/api/me', { method: 'GET' });
        const user = data.user || data;

        const name = user.name || 'Usu치rio';
        const email = user.email || '-';
        const role = user.role || 'user';
        const id = user.id ?? '-';

        welcomeNameSpan.textContent = name;
        infoEmail.textContent = email;
        infoId.textContent = id;
        footerUser.textContent =
          'Usu치rio autenticado: ' + name + ' (' + role + ')';
        roleBadge.textContent = role.toUpperCase();

        if (role === 'admin') {
          roleBadge.style.borderColor = '#2563eb';
          roleBadge.style.background = '#0d2d60';
          btnGoAdmin.style.display = 'inline-flex';
          headerAdminLink.style.display = 'inline-flex';
        } else {
          roleBadge.style.borderColor = '#22c55e';
          roleBadge.style.background = '#064e3b';
          btnGoAdmin.style.display = 'none';
          headerAdminLink.style.display = 'none';
        }

        renderTokenBox(data);
      } catch (err) {
        console.error(err);
        welcomeNameSpan.textContent = 'Erro ao carregar usu치rio';
        infoEmail.textContent = '-';
        infoId.textContent = '-';
        footerUser.textContent =
          'Falha ao carregar usu치rio autenticado.';
      }
    }

    async function loadStats() {
      const totalUsersEl = document.getElementById('totalUsers');
      const statsStatus = document.getElementById('statsStatus');

      totalUsersEl.textContent = '...';
      statsStatus.textContent = 'Carregando usu치rios...';

      try {
        const users = await apiRequest('/api/users', { method: 'GET' });
        totalUsersEl.textContent = users.length;
        statsStatus.textContent = 'Estat칤sticas atualizadas com sucesso.';
      } catch (err) {
        console.error(err);
        statsStatus.textContent =
          'Erro: Sem permiss칚o ou falha na API. (' + err.message + ')';
        totalUsersEl.textContent = '-';
      }
    }

    async function updateStatus() {
      const serverDot = document.getElementById('status-server');
      const dbDot = document.getElementById('status-db');
      const latencyLabel = document.getElementById('latency-label');

      serverDot.className = 'status-indicator gray';
      dbDot.className = 'status-indicator gray';
      latencyLabel.textContent = '---';

      try {
        const res = await fetch('/api/status');
        const data = await res.json();

        serverDot.className = 'status-indicator green';

        if (data.database === 'online') {
          dbDot.className = 'status-indicator green';
        } else {
          dbDot.className = 'status-indicator red';
        }

        if (typeof data.latency_ms === 'number') {
          latencyLabel.textContent = data.latency_ms + ' ms';
        } else {
          latencyLabel.textContent = '---';
        }
      } catch (err) {
        console.error('Erro ao buscar /api/status:', err);
        serverDot.className = 'status-indicator red';
        dbDot.className = 'status-indicator red';
        latencyLabel.textContent = 'erro';
      }
    }

    function setupButtons() {
      const logoutBtn = document.getElementById('logoutBtn');
      const btnGoProfile = document.getElementById('btnGoProfile');
      const btnGoAdmin = document.getElementById('btnGoAdmin');
      const btnRefreshUsers = document.getElementById('btnRefreshUsers');
      const btnRefreshStatus =
        document.getElementById('btn-refresh-status');

      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/html/login.html';
      });

      btnGoProfile.addEventListener('click', () => {
        window.location.href = '/html/profile.html';
      });

      btnGoAdmin.addEventListener('click', () => {
        window.location.href = '/admin/crud.html';
      });

      btnRefreshUsers.addEventListener('click', loadStats);
      btnRefreshStatus.addEventListener('click', updateStatus);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      ensureAuthenticated();
      setupButtons();
      await loadUserInfo();
      await loadStats();
      await updateStatus();
      setInterval(updateStatus, 15000);
    });
  </script>
</body>
</html>
